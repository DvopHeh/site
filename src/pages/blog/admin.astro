---
import Layout from "../../layouts/Layout.astro";

// Check if user is authenticated
const isAuthenticated =
  Astro.cookies.get("blog_admin_auth")?.value === "authenticated";
const loginDisplay = isAuthenticated ? "none" : "flex";
const adminDisplay = isAuthenticated ? "block" : "none";
---

<Layout>
  <!-- Login Screen - Only shown when NOT authenticated -->
  <div class="login-screen" style={`display: ${loginDisplay}`}>
    <div class="login-container">
      <h1>Blog Admin Login</h1>
      <p>Please enter your password to access the admin panel</p>

      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required autofocus />
        </div>

        <button type="submit" class="btn-primary">Login</button>

        <div id="loginError" class="error-message" style="display: none;"></div>
      </form>

      <a href="/blog" class="back-link">‚Üê Back to Blog</a>
    </div>
  </div>

  <style>
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .login-container {
      background: rgba(255, 255, 255, 0.05);
      padding: 3rem;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .login-container h1 {
      margin: 0 0 1rem 0;
      color: var(--text-primary, #fff);
    }

    .login-container p {
      color: var(--text-secondary, #aaa);
      margin-bottom: 2rem;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-group label {
      color: var(--text-secondary, #aaa);
      font-weight: 500;
      text-align: left;
    }

    .form-group input {
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: var(--text-primary, #fff);
      font-family: inherit;
      font-size: 1rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent, #00ffff);
    }

    .error-message {
      padding: 0.75rem;
      background: rgba(255, 0, 0, 0.2);
      color: #ff4444;
      border: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .btn-primary {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      background: var(--accent, #00ffff);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
    }

    .back-link {
      color: var(--accent, #00ffff);
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .back-link:hover {
      opacity: 0.7;
    }
  </style>

  <script>
    // Login functionality
    document
      .getElementById("loginForm")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const passwordInput = document.getElementById(
          "password"
        );
        const errorDiv = document.getElementById("loginError");

        try {
          const response = await fetch("/api/auth", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password: passwordInput.value }),
          });

          const data = await response.json();

          if (data.success) {
            // Reload page - will now show admin interface
            window.location.reload();
          } else {
            if (errorDiv) {
              errorDiv.textContent = "Invalid password";
              errorDiv.style.display = "block";
            }
            passwordInput.value = "";
          }
        } catch (error) {
          console.error("Login error:", error);
          if (errorDiv) {
            errorDiv.textContent = "Login failed. Please try again.";
            errorDiv.style.display = "block";
          }
        }
      });
  </script>

  <!-- Admin Interface - Only rendered when authenticated -->
  <div class="admin-container" style={`display: ${adminDisplay}`}>
    <div class="admin-header">
      <h1>Blog Admin</h1>
      <div class="header-actions">
        <button id="logoutBtn" class="btn-logout">üîí Logout</button>
        <a href="/blog" class="back-link">‚Üê Back to Blog</a>
      </div>
    </div>

    <div class="admin-content">
      <div class="editor-section">
        <h2 id="formTitle">Create New Post</h2>

        <form id="postForm" class="post-form">
          <input type="hidden" id="postId" />

          <div class="form-group">
            <label for="title">Title *</label>
            <input type="text" id="title" required />
          </div>

          <div class="form-group">
            <label for="slug">Slug *</label>
            <input type="text" id="slug" required />
            <small>Auto-generated from title, but you can customize it</small>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea
              id="description"
              rows="2"
              placeholder="Brief description or excerpt"></textarea>
          </div>

          <div class="form-group">
            <label for="featuredImage">Featured Image URL</label>
            <input
              type="url"
              id="featuredImage"
              placeholder="https://example.com/image.jpg"
            />
          </div>

          <div class="form-group">
            <label for="tags">Tags</label>
            <input type="text" id="tags" placeholder="Comma-separated tags" />
          </div>

          <!-- Image Upload Section -->
          <div class="image-upload-section">
            <label>Upload Images</label>
            <div class="upload-container">
              <input
                type="file"
                id="imageUpload"
                accept="image/jpeg,image/png,image/gif,image/webp"
                style="display: none;"
              />
              <div id="dropZone" class="drop-zone">
                <div class="drop-zone-content">
                  <span class="upload-icon">üìÅ</span>
                  <p>Drag & drop images here or</p>
                  <button
                    type="button"
                    id="selectImageBtn"
                    class="btn-secondary btn-small">Choose File</button
                  >
                  <small>JPG, PNG, GIF, WebP (max 5MB)</small>
                </div>
              </div>
              <div
                id="uploadProgress"
                class="upload-progress"
                style="display: none;"
              >
                <div class="progress-bar">
                  <div id="progressBarFill" class="progress-bar-fill"></div>
                </div>
                <span id="progressText">Uploading...</span>
              </div>
              <div
                id="uploadedImage"
                class="uploaded-image"
                style="display: none;"
              >
                <img id="uploadedImagePreview" alt="Uploaded" />
                <div class="image-actions">
                  <input
                    type="text"
                    id="imageUrl"
                    readonly
                    class="image-url-input"
                  />
                  <button
                    type="button"
                    id="copyUrlBtn"
                    class="btn-secondary btn-small">üìã Copy URL</button
                  >
                  <button
                    type="button"
                    id="insertMdBtn"
                    class="btn-primary btn-small">üìù Insert Markdown</button
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="editor-preview-container">
            <div class="editor-pane">
              <label for="content">Content (Markdown) *</label>
              <textarea
                id="content"
                rows="15"
                required
                placeholder="Write your post content in Markdown..."></textarea>
            </div>

            <div class="preview-pane">
              <label>Live Preview</label>
              <div id="preview" class="markdown-preview"></div>
            </div>
          </div>

          <div class="form-actions">
            <label class="checkbox-label">
              <input type="checkbox" id="published" />
              <span>Published</span>
            </label>
          </div>

          <div class="form-buttons">
            <button type="submit" class="btn-primary">Save Post</button>
            <button type="button" id="clearBtn" class="btn-secondary">
              Clear Form
            </button>
          </div>
        </form>

        <div id="notification" class="notification" style="display: none;">
        </div>
      </div>

      <div class="posts-list">
        <h2>Existing Posts</h2>
        <div id="postsList" class="posts-container">
          <div class="loading">Loading posts...</div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    margin: 0;
    color: var(--text-primary, #fff);
  }

  .header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .btn-logout {
    padding: 0.5rem 1rem;
    background: rgba(255, 0, 0, 0.2);
    color: #ff4444;
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }

  .btn-logout:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: translateY(-2px);
  }

  .back-link {
    color: var(--accent, #00ffff);
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .back-link:hover {
    opacity: 0.7;
  }

  .admin-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
  }

  .editor-section {
    background: rgba(255, 255, 255, 0.05);
    padding: 2rem;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .editor-section h2 {
    margin: 0 0 1.5rem 0;
    color: var(--text-primary, #fff);
  }

  .post-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    color: var(--text-secondary, #aaa);
    font-weight: 500;
  }

  .form-group input,
  .form-group textarea {
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: var(--text-primary, #fff);
    font-family: inherit;
    font-size: 1rem;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--accent, #00ffff);
  }

  .form-group small {
    color: var(--text-secondary, #888);
    font-size: 0.875rem;
  }

  /* Image Upload Section */
  .image-upload-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .image-upload-section label {
    color: var(--text-secondary, #aaa);
    font-weight: 500;
  }

  .upload-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .drop-zone {
    border: 2px dashed rgba(0, 255, 255, 0.3);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: rgba(0, 255, 255, 0.05);
    transition: all 0.3s;
    cursor: pointer;
  }

  .drop-zone:hover,
  .drop-zone.drag-over {
    border-color: var(--accent, #00ffff);
    background: rgba(0, 255, 255, 0.1);
  }

  .drop-zone-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .upload-icon {
    font-size: 3rem;
  }

  .drop-zone p {
    margin: 0;
    color: var(--text-secondary, #aaa);
  }

  .drop-zone small {
    color: var(--text-secondary, #666);
    font-size: 0.8rem;
  }

  .upload-progress {
    text-align: center;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--accent, #00ffff);
    transition: width 0.3s;
    width: 0%;
  }

  #progressText {
    color: var(--text-secondary, #aaa);
    font-size: 0.9rem;
  }

  .uploaded-image {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .uploaded-image img {
    max-width: 100%;
    max-height: 200px;
    object-fit: contain;
    border-radius: 6px;
  }

  .image-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .image-url-input {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: var(--text-primary, #fff);
    font-size: 0.85rem;
    font-family: monospace;
  }

  .btn-small {
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
  }

  .editor-preview-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .editor-pane,
  .preview-pane {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .markdown-preview {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 1rem;
    min-height: 400px;
    overflow-y: auto;
    color: var(--text-primary, #fff);
    line-height: 1.6;
  }

  .markdown-preview h1,
  .markdown-preview h2,
  .markdown-preview h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--accent, #00ffff);
  }

  .markdown-preview p {
    margin-bottom: 1rem;
  }

  .markdown-preview code {
    background: rgba(0, 0, 0, 0.5);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: monospace;
  }

  .markdown-preview pre {
    background: rgba(0, 0, 0, 0.5);
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
  }

  .markdown-preview pre code {
    background: none;
    padding: 0;
  }

  .markdown-preview img {
    max-width: 100%;
    border-radius: 6px;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary, #aaa);
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    width: auto;
    cursor: pointer;
  }

  .form-buttons {
    display: flex;
    gap: 1rem;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .btn-primary {
    background: var(--accent, #00ffff);
    color: #000;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary, #fff);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  .notification {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 6px;
    font-weight: 500;
  }

  .notification.success {
    background: rgba(0, 255, 0, 0.2);
    color: #00ff00;
    border: 1px solid rgba(0, 255, 0, 0.3);
  }

  .notification.error {
    background: rgba(255, 0, 0, 0.2);
    color: #ff4444;
    border: 1px solid rgba(255, 0, 0, 0.3);
  }

  .posts-list {
    background: rgba(255, 255, 255, 0.05);
    padding: 2rem;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .posts-list h2 {
    margin: 0 0 1.5rem 0;
    color: var(--text-primary, #fff);
  }

  .posts-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .post-item {
    background: rgba(0, 0, 0, 0.3);
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s;
  }

  .post-item:hover {
    border-color: var(--accent, #00ffff);
    transform: translateX(5px);
  }

  .post-item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
  }

  .post-item-title {
    color: var(--text-primary, #fff);
    font-weight: 500;
    margin: 0;
  }

  .post-item-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-edit,
  .btn-delete {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-edit {
    background: rgba(0, 255, 255, 0.2);
    color: var(--accent, #00ffff);
  }

  .btn-edit:hover {
    background: rgba(0, 255, 255, 0.3);
  }

  .btn-delete {
    background: rgba(255, 0, 0, 0.2);
    color: #ff4444;
  }

  .btn-delete:hover {
    background: rgba(255, 0, 0, 0.3);
  }

  .post-item-meta {
    color: var(--text-secondary, #888);
    font-size: 0.85rem;
  }

  .loading {
    text-align: center;
    color: var(--text-secondary, #aaa);
    padding: 2rem;
  }

  @media (max-width: 1024px) {
    .admin-content {
      grid-template-columns: 1fr;
    }

    .editor-preview-container {
      grid-template-columns: 1fr;
    }
  }
</style>

<script type="module">
  import MarkdownIt from "https://esm.sh/markdown-it@14";

  const md = new MarkdownIt({
    html: true,
    linkify: true,
    typographer: true,
  });

  let editingPostId = null;

  // Load posts on page load
  async function loadPosts() {
    try {
      const response = await fetch("/api/blog");
      const posts = await response.json();

      const container = document.getElementById("postsList");
      if (!container) return;

      if (posts.length === 0) {
        container.innerHTML = '<div class="loading">No posts yet</div>';
        return;
      }

      container.innerHTML = posts
        .map(
          (post) => `
          <div class="post-item">
            <div class="post-item-header">
              <h3 class="post-item-title">${post.title}</h3>
              <div class="post-item-actions">
                <button class="btn-edit" onclick="editPost(${post.id})">Edit</button>
                <button class="btn-delete" onclick="deletePost(${post.id})">Delete</button>
              </div>
            </div>
            <div class="post-item-meta">
              ${post.published ? "‚úì Published" : "‚úó Draft"} ‚Ä¢ 
              ${new Date(post.created_at).toLocaleDateString()}
            </div>
          </div>
        `
        )
        .join("");
    } catch (error) {
      console.error("Error loading posts:", error);
    }
  }

  // Edit post
  window.editPost = async function (id) {
    try {
      const response = await fetch("/api/blog");
      const posts = await response.json();
      const post = posts.find((p) => p.id === id);

      if (!post) return;

      editingPostId = id;
      (document.getElementById("postId")).value =
        id.toString();
      (document.getElementById("title")).value = post.title;
      (document.getElementById("slug")).value = post.slug;
      (document.getElementById("description")).value =
        post.description || "";
      (document.getElementById("featuredImage")).value =
        post.featured_image || "";
      (document.getElementById("tags")).value =
        post.tags || "";
      (document.getElementById("content")).value =
        post.content;
      (document.getElementById("published")).checked =
        post.published;

      document.getElementById("formTitle")!.textContent = "Edit Post";

      // Update preview
      const preview = document.getElementById("preview");
      if (preview) {
        preview.innerHTML = md.render(post.content);
      }

      // Scroll to form
      document
        .querySelector(".editor-section")
        ?.scrollIntoView({ behavior: "smooth" });
    } catch (error) {
      console.error("Error loading post:", error);
    }
  };

  // Delete post
  window.deletePost = async function (id) {
    if (!confirm("Are you sure you want to delete this post?")) return;

    try {
      const response = await fetch("/api/blog", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ id }),
      });

      if (response.ok) {
        showNotification("Post deleted successfully!", "success");
        loadPosts();
      } else {
        throw new Error("Failed to delete post");
      }
    } catch (error) {
      console.error("Error deleting post:", error);
      showNotification("Failed to delete post", "error");
    }
  };

  // Form submission
  document.getElementById("postForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = (document.getElementById("title")).value;
    const slug = (document.getElementById("slug")).value;
    const description = (
      document.getElementById("description")
    ).value;
    const featuredImage = (
      document.getElementById("featuredImage")
    ).value;
    const tags = (document.getElementById("tags")).value;
    const content = (document.getElementById("content"))
      .value;
    const published = (document.getElementById("published"))
      .checked;

    const data = {
      title,
      slug,
      description,
      featured_image: featuredImage,
      tags,
      content,
      published,
      author: "dvop",
    };

    try {
      let response;
      if (editingPostId) {
        response = await fetch("/api/blog", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ id: editingPostId, ...data }),
        });
      } else {
        response = await fetch("/api/blog", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });
      }

      if (response.ok) {
        showNotification(
          editingPostId
            ? "Post updated successfully!"
            : "Post created successfully!",
          "success"
        );
        clearForm();
        loadPosts();
      } else {
        throw new Error("Failed to save post");
      }
    } catch (error) {
      console.error("Error saving post:", error);
      showNotification("Failed to save post", "error");
    }
  });

  // Auto-generate slug from title
  document.getElementById("title")?.addEventListener("input", (e) => {
    const title = (e.target).value;
    const slugInput = document.getElementById("slug");

    if (!editingPostId || !slugInput.value) {
      const slug = title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
      slugInput.value = slug;
    }
  });

  // Live markdown preview
  document.getElementById("content")?.addEventListener("input", (e) => {
    const content = (e.target).value;
    const preview = document.getElementById("preview");
    if (preview) {
      preview.innerHTML = md.render(content);
    }
  });

  // Clear form
  document.getElementById("clearBtn")?.addEventListener("click", clearForm);

  function clearForm() {
    editingPostId = null;
    (document.getElementById("postForm")).reset();
    (document.getElementById("postId")).value = "";
    document.getElementById("formTitle")!.textContent = "Create New Post";
    const preview = document.getElementById("preview");
    if (preview) {
      preview.innerHTML = "";
    }
  }

  // Show notification
  function showNotification(message, type: "success" | "error") {
    const notification = document.getElementById("notification");
    if (!notification) return;

    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = "block";

    setTimeout(() => {
      notification.style.display = "none";
    }, 3000);
  }

  // Image Upload Functionality
  const imageUploadInput = document.getElementById(
    "imageUpload"
  );
  const selectImageBtn = document.getElementById("selectImageBtn");
  const dropZone = document.getElementById("dropZone");
  const uploadProgress = document.getElementById("uploadProgress");
  const progressBarFill = document.getElementById("progressBarFill");
  const progressText = document.getElementById("progressText");
  const uploadedImage = document.getElementById("uploadedImage");
  const uploadedImagePreview = document.getElementById(
    "uploadedImagePreview"
  );
  const imageUrlInput = document.getElementById("imageUrl");
  const copyUrlBtn = document.getElementById("copyUrlBtn");
  const insertMdBtn = document.getElementById("insertMdBtn");

  // Click to select file
  selectImageBtn?.addEventListener("click", () => {
    imageUploadInput?.click();
  });

  // Drag and drop handlers
  dropZone?.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("drag-over");
  });

  dropZone?.addEventListener("dragleave", () => {
    dropZone.classList.remove("drag-over");
  });

  dropZone?.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag-over");

    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      handleImageUpload(files[0]);
    }
  });

  // File input change
  imageUploadInput?.addEventListener("change", (e) => {
    const files = (e.target).files;
    if (files && files.length > 0) {
      handleImageUpload(files[0]);
    }
  });

  // Handle image upload
  async function handleImageUpload(file: File) {
    // Validate file type
    const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];
    if (!allowedTypes.includes(file.type)) {
      showNotification(
        "Invalid file type. Only JPG, PNG, GIF, and WebP are allowed.",
        "error"
      );
      return;
    }

    // Validate file size (5MB)
    if (file.size > 5 * 1024 * 1024) {
      showNotification("File too large. Maximum size is 5MB.", "error");
      return;
    }

    // Show progress
    if (dropZone) dropZone.style.display = "none";
    if (uploadedImage) uploadedImage.style.display = "none";
    if (uploadProgress) uploadProgress.style.display = "block";
    if (progressBarFill) progressBarFill.style.width = "50%";

    try {
      const formData = new FormData();
      formData.append("image", file);

      const response = await fetch("/api/upload", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();

      if (data.success) {
        // Show uploaded image
        if (progressBarFill) progressBarFill.style.width = "100%";

        setTimeout(() => {
          if (uploadProgress) uploadProgress.style.display = "none";
          if (uploadedImage) uploadedImage.style.display = "flex";
          if (uploadedImagePreview) uploadedImagePreview.src = data.url;
          if (imageUrlInput) imageUrlInput.value = data.url;
          if (dropZone) dropZone.style.display = "flex";
        }, 500);

        showNotification("Image uploaded successfully!", "success");
      } else {
        throw new Error(data.error || "Upload failed");
      }
    } catch (error) {
      console.error("Upload error:", error);
      showNotification("Failed to upload image. Please try again.", "error");
      if (uploadProgress) uploadProgress.style.display = "none";
      if (dropZone) dropZone.style.display = "flex";
      if (progressBarFill) progressBarFill.style.width = "0%";
    }

    // Reset file input
    if (imageUploadInput) imageUploadInput.value = "";
  }

  // Copy URL to clipboard
  copyUrlBtn?.addEventListener("click", async () => {
    if (imageUrlInput) {
      try {
        await navigator.clipboard.writeText(imageUrlInput.value);
        showNotification("URL copied to clipboard!", "success");
      } catch (error) {
        // Fallback for older browsers
        imageUrlInput.select();
        document.execCommand("copy");
        showNotification("URL copied to clipboard!", "success");
      }
    }
  });

  // Insert markdown
  insertMdBtn?.addEventListener("click", () => {
    const contentTextarea = document.getElementById(
      "content"
    );
    if (contentTextarea && imageUrlInput) {
      const imageUrl = imageUrlInput.value;
      const markdown = `\n![Image](${imageUrl})\n`;

      // Insert at cursor position
      const start = contentTextarea.selectionStart;
      const end = contentTextarea.selectionEnd;
      const text = contentTextarea.value;

      contentTextarea.value =
        text.substring(0, start) + markdown + text.substring(end);

      // Update preview
      const preview = document.getElementById("preview");
      if (preview) {
        preview.innerHTML = md.render(contentTextarea.value);
      }

      showNotification("Markdown inserted into content!", "success");

      // Focus back on textarea
      contentTextarea.focus();
      contentTextarea.setSelectionRange(
        start + markdown.length,
        start + markdown.length
      );
    }
  });

  // Logout functionality
  document.getElementById("logoutBtn")?.addEventListener("click", async () => {
    try {
      await fetch("/api/auth", { method: "DELETE" });
      window.location.reload();
    } catch (error) {
      console.error("Logout error:", error);
    }
  });

  // Load posts on page load
  document.addEventListener("DOMContentLoaded", loadPosts);
</script>
