---
// src/components/Guestbook.astro
const { request } = Astro;

// Fetch existing entries
let entries = [];
try {
  const result = await Astro.locals.runtime.env.DB.prepare(
    'SELECT * FROM guestbook_entries ORDER BY created_at DESC LIMIT 50'
  ).all();
  entries = result.results || [];
} catch (error) {
  console.error('Error fetching entries:', error);
}
---

<div class="guestbook">
  <form class="form" action="/api/guestbook" method="POST">
    <input type="text" name="name" placeholder="Name" required>
    <textarea name="message" placeholder="Message" required rows="2"></textarea>
    <button type="submit">Add Entry</button>
  </form>
  
  <div class="header">
    <span class="count">{entries.length} entries</span>
  </div>
  
  <div id="entries">
    {entries.length === 0 ? (
      <div class="no-entries">No entries yet!</div>
    ) : (
      entries.map(entry => (
        <div class="entry">
          <div>
            <span class="entry-name">{entry.name}</span>
            <span class="entry-date">{new Date(entry.created_at).toLocaleString()}</span>
          </div>
          <div class="entry-message">{entry.message}</div>
        </div>
      ))
    )}
  </div>
</div>