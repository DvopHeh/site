<script>
    // wait a tiny bit for DOM elements to be available
    setTimeout(function() {
        // theme stuff that hopefully works across pages now
        var savedTheme = localStorage.getItem('theme');
        var systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        // use saved theme if exists, otherwise use system preference
        var currentTheme;
        if (savedTheme) {
            currentTheme = savedTheme;
        } else {
            currentTheme = systemIsDark ? 'dark' : 'light';
        }
        
        // set theme and icon
        document.documentElement.setAttribute('data-theme', currentTheme);
        var themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
            if (currentTheme == 'dark') {
                themeIcon.className = 'bi bi-sun-fill';
            } else {
                themeIcon.className = 'bi bi-moon-fill';
            }
        }

        // only listen to system changes if no saved theme
        if (!savedTheme) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                var themeIcon = document.getElementById('theme-icon');
                if (e.matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    if (themeIcon) themeIcon.className = 'bi bi-sun-fill';
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    if (themeIcon) themeIcon.className = 'bi bi-moon-fill';
                }
            });
        }
        
        // toggle and save to localStorage
        var themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.onclick = function() {
                var currentTheme = document.documentElement.getAttribute('data-theme');
                var newTheme;
                
                if (currentTheme == 'dark') {
                    newTheme = 'light';
                } else {
                    newTheme = 'dark';
                }
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                var themeIcon = document.getElementById('theme-icon');
                if (themeIcon) {
                    if (newTheme == 'light') {
                        themeIcon.className = 'bi bi-moon-fill';
                    } else {
                        themeIcon.className = 'bi bi-sun-fill';
                    }
                }
            }
        }
    }, 0);
</script>